// ============================================
// CRM OMNICHANNEL SAAS - MULTI-TENANT DATABASE SCHEMA
// Canais suportados: WhatsApp, Messenger, Instagram
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT (Organização/Hotel)
// Cada hotel é um tenant isolado
// ============================================
model Tenant {
  id    String @id @default(uuid())
  name  String // "Hotel Copacabana Palace"
  slug  String @unique // "hotelcopacabana" (usado no subdomínio)
  email String @unique

  // Status
  status TenantStatus @default(TRIAL)
  plan   Plan         @default(BASIC)

  // Limites por plano
  maxAttendants Int @default(10)
  maxMessages   Int @default(10000) // Por mês

  // Billing/Assinatura
  stripeCustomerId     String?             @unique
  stripeSubscriptionId String?             @unique
  subscriptionStatus   SubscriptionStatus?
  currentPeriodEnd     DateTime?
  trialEndsAt          DateTime?

  // WhatsApp Config (cada tenant tem suas credenciais)
  whatsappPhoneNumberId      String?
  whatsappAccessToken        String? // Criptografado em produção
  whatsappBusinessAccountId  String?
  whatsappWebhookVerifyToken String?
  whatsappAppSecret          String? // Para validar webhooks

  // N8N Integration
  n8nApiKey     String? // Chave de API para integracao N8N
  n8nWebhookUrl String? // URL do webhook do N8N para encaminhar mensagens
  n8nWebhookUrlMessenger  String? // URL do webhook N8N para canal Messenger
  n8nWebhookUrlInstagram  String? // URL do webhook N8N para canal Instagram

  // Messenger Config (por tenant)
  messengerPageId      String? // Page ID do Facebook
  messengerAccessToken String? // Page Access Token (criptografado)

  // Instagram Config (por tenant)
  instagramAccountId   String? // Instagram Account ID
  instagramAccessToken String? // Access Token (criptografado)

  // Metadata
  metadata Json? // Dados customizados

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações (todos os dados isolados por tenant)
  users         User[]
  contacts      Contact[]
  conversations Conversation[]
  messages      Message[]
  tags          Tag[]
  quickReplies  QuickReply[]
  usageTracking UsageTracking[]

  @@index([slug])
  @@index([status])
  @@index([email])
  @@map("tenants")
}

enum TenantStatus {
  TRIAL // Período de teste (14 dias grátis)
  ACTIVE // Ativo e pagando
  SUSPENDED // Suspenso por falta de pagamento
  CANCELLED // Cancelado
}

enum Plan {
  BASIC // Plano único inicial
  PRO // Futuro
  ENTERPRISE // Futuro
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  INCOMPLETE
  TRIALING
}

// ============================================
// CHANNEL (Canal de comunicacao)
// ============================================
enum Channel {
  WHATSAPP
  MESSENGER
  INSTAGRAM
}

// ============================================
// USER (Usuários do sistema)
// SUPER_ADMIN: Não tem tenantId (você/empresa)
// TENANT_ADMIN: Admin do hotel
// ATTENDANT: Atendente do hotel
// ============================================
model User {
  id       String  @id @default(uuid())
  tenantId String? // NULL = Super Admin

  email    String     @unique
  password String // Hash bcrypt
  name     String
  role     Role       @default(ATTENDANT)
  status   UserStatus @default(ACTIVE)

  // Avatar/Profile
  avatarUrl String?

  // Unidade hoteleira (para ATTENDANT - filtra conversas automaticamente)
  // Valores: "Ilhabela", "Campos do Jordão", "Camburi", "Santo Antônio do Pinhal"
  // NULL = TENANT_ADMIN vê todas as unidades
  hotelUnit String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  // Relações
  tenant             Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations      Conversation[] // Conversas atribuídas
  quickRepliesCreated QuickReply[]  @relation("QuickReplyCreatedBy")

  @@index([tenantId])
  @@index([email])
  @@index([tenantId, status])
  @@index([tenantId, hotelUnit])
  @@map("users")
}

enum Role {
  SUPER_ADMIN // Acesso total ao sistema (você/empresa)
  TENANT_ADMIN // Admin do hotel (gerencia atendentes)
  HEAD // Supervisor (vê todas conversas, não gerencia usuários)
  ATTENDANT // Atendente do hotel (responde conversas)
  SALES // Vendas (vê apenas oportunidades de venda)
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

// ============================================
// CONTACT (Contatos omnichannel)
// Isolado por tenant + canal
// ============================================
model Contact {
  id       String @id @default(uuid())
  tenantId String // IMPORTANTE: Isola contatos

  // Canal de origem do contato
  channel    Channel @default(WHATSAPP)
  externalId String  // WA: phoneNumber, Messenger: PSID, Instagram: IGSID

  phoneNumber       String? // Telefone (obrigatorio para WA, opcional para Messenger/IG)
  name              String?
  profilePictureUrl String?
  email             String?

  // Metadata customizada
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  // Constraint: Mesmo externalId pode existir em tenants/canais diferentes
  @@unique([tenantId, channel, externalId])
  @@index([tenantId, channel, externalId])
  @@index([tenantId, phoneNumber])
  @@index([tenantId])
  @@map("contacts")
}

// ============================================
// CONVERSATION (Conversa/Ticket)
// Isolado por tenant
// ============================================
model Conversation {
  id       String @id @default(uuid())
  tenantId String // IMPORTANTE: Isola conversas

  contactId    String
  assignedToId String? // User que está atendendo
  status       ConversationStatus @default(OPEN)
  priority     Priority           @default(MEDIUM)

  // Canal da conversa (WhatsApp, Messenger, Instagram)
  channel Channel @default(WHATSAPP)

  // Campo source para rastrear origem
  source String? // "n8n", "manual", "webhook"

  // Unidade hoteleira da conversa (para filtrar por atendente)
  // Valores: "Ilhabela", "Campos do Jordão", "Camburi", "Santo Antônio do Pinhal"
  hotelUnit String?

  // Controle de IA - quando true, IA não responde esta conversa
  iaLocked   Boolean   @default(false)
  iaLockedAt DateTime? // Quando a IA foi travada
  iaLockedBy String? // User ID que travou (ou "system" se automático)

  // Oportunidade de venda - quando cliente não converteu no follow-up
  isOpportunity Boolean   @default(false) // true = oportunidade para time de vendas
  opportunityAt DateTime? // Quando foi marcada como oportunidade

  // Timestamps importantes
  lastMessageAt DateTime  @default(now())
  createdAt     DateTime  @default(now())
  closedAt      DateTime?

  // Metadata
  metadata Json?

  // Relações
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact     Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assignedTo  User?        @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  messages    Message[]
  tags        Tag[]
  escalations Escalation[]

  @@index([tenantId, status, lastMessageAt])
  @@index([tenantId, channel, status, lastMessageAt])
  @@index([tenantId, status, assignedToId, lastMessageAt])
  @@index([tenantId, assignedToId])
  @@index([tenantId, contactId])
  @@index([tenantId, source])
  @@index([tenantId, createdAt])
  @@index([tenantId, iaLocked])
  @@index([tenantId, hotelUnit])
  @@index([tenantId, hotelUnit, status, lastMessageAt])
  @@index([tenantId, isOpportunity, opportunityAt]) // Para consultas de oportunidades do time de vendas
  @@index([contactId])
  @@map("conversations")
}

enum ConversationStatus {
  BOT_HANDLING // Sendo atendida pela IA (não aparece no Kanban)
  OPEN // Nova conversa, aguardando atendimento
  IN_PROGRESS // Atendente está conversando
  WAITING // Aguardando resposta do cliente
  CLOSED // Finalizada
  ARCHIVED // Arquivada (não aparece em listas)
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// MESSAGE (Mensagens)
// Isolado por tenant
// ============================================
model Message {
  id       String @id @default(uuid())
  tenantId String // IMPORTANTE: Isola mensagens

  conversationId String

  // ID externo da mensagem (WhatsApp wamid, Messenger mid, Instagram mid)
  externalMessageId String? @unique

  direction Direction
  type      MessageType
  content   String      @db.Text

  // Metadata (mídia URLs, location data, etc)
  metadata Json?

  status   MessageStatus @default(SENT)
  sentById String? // User que enviou (se OUTBOUND)

  // Timestamp real da mensagem (não o createdAt)
  timestamp DateTime

  // Audit
  createdAt DateTime @default(now())

  // Relações
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([tenantId, conversationId, timestamp])
  @@index([conversationId, timestamp])
  @@index([tenantId, timestamp])
  @@index([externalMessageId])
  // Índice para contagem de mensagens não lidas (usado em listConversations)
  @@index([conversationId, direction, status])
  @@map("messages")
}

enum Direction {
  INBOUND // Cliente → Atendente
  OUTBOUND // Atendente → Cliente
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  LOCATION
  STICKER
  TEMPLATE // Template pré-aprovado da Meta
  INTERACTIVE // Botões ou listas interativas
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

// ============================================
// TAG (Etiquetas/Labels)
// Isolado por tenant
// ============================================
model Tag {
  id       String @id @default(uuid())
  tenantId String // Cada tenant suas próprias tags

  name  String
  color String // Hex color: #FF5733

  createdAt DateTime @default(now())

  // Relações
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("tags")
}

// ============================================
// QUICK REPLY (Respostas rapidas para atendentes)
// Atalhos /comando no chat - Isolado por tenant
// ============================================
model QuickReply {
  id        String  @id @default(uuid())
  tenantId  String

  title     String      // "Check-in e Check-out"
  shortcut  String      // "checkin" (sem /)
  content   String  @db.Text
  category  String?     // "Politicas", "Vendas"
  order     Int     @default(0)
  isActive  Boolean @default(true)

  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User?  @relation("QuickReplyCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([tenantId, shortcut])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("quick_replies")
}

// ============================================
// USAGE TRACKING (Para billing e limites)
// Rastreia uso de cada tenant
// ============================================
model UsageTracking {
  id       String @id @default(uuid())
  tenantId String

  // Período (YYYY-MM-01 para mês)
  period DateTime

  // Contadores
  messagesCount      Int @default(0)
  conversationsCount Int @default(0)
  activeUsers        Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, period])
  @@index([tenantId, period])
  @@map("usage_tracking")
}

// ============================================
// ESCALATION (Escalações de IA para Humano)
// Registro de quando a IA transfere para atendente
// ============================================
model Escalation {
  id       String @id @default(uuid())
  tenantId String

  conversationId String

  // Motivo da escalação
  reason       EscalationReason
  reasonDetail String?          @db.Text // Descrição livre do motivo

  // Unidade hoteleira (Campos do Jordão, Ilhabela, etc)
  hotelUnit String?

  // Contexto da IA no momento da escalação
  aiContext Json? // Histórico de mensagens, intent detectada, etc

  // Status da escalação
  status       EscalationStatus @default(PENDING)
  attendedById String? // User que atendeu
  attendedAt   DateTime? // Quando foi atendida

  // Timestamps
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  // Relações
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
  @@index([conversationId])
  @@index([tenantId, hotelUnit])
  @@map("escalations")
}

enum EscalationReason {
  USER_REQUESTED // Cliente pediu para falar com humano
  AI_UNABLE // IA não conseguiu resolver
  COMPLEX_QUERY // Consulta complexa
  COMPLAINT // Reclamação
  SALES_OPPORTUNITY // Oportunidade de venda
  URGENCY // Urgência detectada
  OTHER // Outro motivo
}

enum EscalationStatus {
  PENDING // Aguardando atendimento
  IN_PROGRESS // Sendo atendida
  RESOLVED // Resolvida
  CANCELLED // Cancelada (cliente desistiu)
}

// ============================================
// AUDIT LOG (Logs de auditoria - Opcional mas recomendado)
// Para rastrear ações importantes
// ============================================
model AuditLog {
  id       String  @id @default(uuid())
  tenantId String?

  userId String? // Quem fez a ação
  action String // "CREATE_USER", "DELETE_CONVERSATION", etc
  entity String // "User", "Conversation", etc

  entityId String? // ID da entidade afetada

  // Dados antes e depois (para rollback se necessário)
  oldData Json?
  newData Json?

  metadata Json? // IP, User-Agent, etc

  createdAt DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// ============================================
// WEBHOOK EVENT (Log de webhooks recebidos - Debug)
// Útil para debugging de problemas com WhatsApp
// ============================================
model WebhookEvent {
  id       String  @id @default(uuid())
  tenantId String?

  source  String // "whatsapp", "stripe", etc
  event   String // Tipo do evento
  payload Json // Payload completo

  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?   @db.Text

  createdAt DateTime @default(now())

  @@index([tenantId, processed])
  @@index([createdAt])
  @@map("webhook_events")
}
