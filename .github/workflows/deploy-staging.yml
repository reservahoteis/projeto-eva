name: Deploy to Dev VPS

on:
  push:
    branches:
      - develop
    paths:
      - 'deploy-backend/**'
      - '.github/workflows/deploy-staging.yml'
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_PATH: /root/deploy-backend-dev

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: deploy-backend/package-lock.json

      - name: Install dependencies
        working-directory: deploy-backend
        run: npm ci

      - name: Run linting
        working-directory: deploy-backend
        run: npm run lint || echo "::warning::Linting issues found"

      - name: Run type check
        working-directory: deploy-backend
        run: npx tsc --noEmit || echo "::warning::Type check issues found"

      - name: Run tests
        working-directory: deploy-backend
        run: npm run test -- --passWithNoTests
        env:
          NODE_ENV: test

  deploy:
    name: Deploy to Dev VPS
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # ssh-keyscan com timeout e fallback
          ssh-keyscan -t ed25519,rsa -T 10 -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          # SSH config global
          cat >> ~/.ssh/config << SSHEOF
          Host *
            StrictHostKeyChecking accept-new
            IdentityFile ~/.ssh/deploy_key
            ConnectTimeout 10
            ServerAliveInterval 30
            ServerAliveCountMax 3
          SSHEOF
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'SSH OK'"

      - name: Sync files to VPS
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude 'coverage' \
            --exclude 'backups' \
            --exclude '*.test.ts' \
            --exclude 'src/test' \
            deploy-backend/ \
            ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.VPS_PATH }}/

      - name: Build and restart container
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            set -e
            cd /root/deploy-backend-dev

            echo "Building Docker image..."
            docker compose -f docker-compose.dev.yml build backend-dev

            echo "Stopping and removing old container..."
            docker stop crm-backend-dev 2>/dev/null || true
            docker rm -f crm-backend-dev 2>/dev/null || true

            echo "Starting new container..."
            docker compose -f docker-compose.dev.yml up -d --no-deps backend-dev

            echo "Waiting for container..."
            sleep 10

            echo "Running migrations..."
            docker compose -f docker-compose.dev.yml exec -T backend-dev npx prisma migrate deploy || true

            echo "Container status:"
            docker compose -f docker-compose.dev.yml ps backend-dev
          EOF

      - name: Health check
        run: |
          for i in $(seq 1 20); do
            RESPONSE=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:3002/health" || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "Health check OK!"
              exit 0
            fi
            echo "Attempt $i/20 - Status: $RESPONSE"
            sleep 5
          done
          echo "Health check failed"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "docker logs crm-backend-dev --tail=30"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f ~/.ssh/config
