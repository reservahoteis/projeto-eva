name: Deploy to Production VPS

on:
  push:
    branches:
      - main
    paths:
      - 'deploy-backend/**'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_PATH: /root/deploy-backend

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: deploy-backend/package-lock.json

      - name: Install dependencies
        working-directory: deploy-backend
        run: npm ci

      - name: Run linting
        working-directory: deploy-backend
        run: npm run lint || echo "::warning::Linting issues found"

      - name: Run type check
        working-directory: deploy-backend
        run: npx tsc --noEmit || echo "::warning::Type check issues found"

      - name: Run tests
        working-directory: deploy-backend
        run: npm run test -- --passWithNoTests
        env:
          NODE_ENV: test

  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # ssh-keyscan com timeout e fallback
          ssh-keyscan -t ed25519,rsa -T 10 -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          # SSH config global para usar a key e aceitar hosts novos
          cat >> ~/.ssh/config << SSHEOF
          Host *
            StrictHostKeyChecking accept-new
            IdentityFile ~/.ssh/deploy_key
            ConnectTimeout 10
            ServerAliveInterval 30
            ServerAliveCountMax 3
          SSHEOF
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'SSH OK'"

      - name: Create backup and save current image
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            set -e
            cd /root/deploy-backend
            mkdir -p backups

            # Backup do banco de dados
            if docker ps | grep -q crm-postgres; then
              echo "Creating database backup..."
              docker exec crm-postgres pg_dump -U crm_user crm_whatsapp_saas > "backups/pre-deploy-$(date +%Y%m%d-%H%M%S).sql" 2>/dev/null || echo "Warning: Database backup failed"
            fi

            # Salvar imagem atual para rollback
            if docker images | grep -q "deploy-backend-backend"; then
              echo "Saving current image for rollback..."
              docker tag deploy-backend-backend:latest deploy-backend-backend:rollback 2>/dev/null || true
            fi

            # Limpar backups antigos (manter ultimos 5)
            ls -t backups/*.sql 2>/dev/null | tail -n +6 | xargs -r rm -f || true
          EOF

      - name: Sync files to VPS
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude 'coverage' \
            --exclude 'backups' \
            --exclude 'certbot' \
            --exclude '*.test.ts' \
            --exclude 'src/test' \
            --exclude 'logs' \
            --exclude 'uploads' \
            deploy-backend/ \
            ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.VPS_PATH }}/

      - name: Build and restart container
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            set -e
            cd /root/deploy-backend

            echo "Building Docker image..."
            docker compose -f docker-compose.production.yml build backend

            echo "Stopping and removing old container..."
            docker stop crm-backend 2>/dev/null || true
            docker rm -f crm-backend 2>/dev/null || true

            echo "Starting new container..."
            docker compose -f docker-compose.production.yml up -d --no-deps backend

            echo "Waiting for container to start..."
            sleep 10

            echo "Running migrations..."
            if ! docker compose -f docker-compose.production.yml exec -T backend npx prisma migrate deploy; then
              echo "ERROR: Migration failed!"
              echo "Rolling back to previous image..."
              if docker images | grep -q "deploy-backend-backend:rollback"; then
                docker tag deploy-backend-backend:rollback deploy-backend-backend:latest
                docker stop crm-backend 2>/dev/null || true
                docker rm -f crm-backend 2>/dev/null || true
                docker compose -f docker-compose.production.yml up -d --no-deps backend
                echo "Rollback completed. Please check migrations manually."
              fi
              exit 1
            fi

            echo "Container status:"
            docker compose -f docker-compose.production.yml ps backend
          EOF

      - name: Health check with rollback
        run: |
          for i in $(seq 1 30); do
            RESPONSE=$(curl -s -o /dev/null -w '%{http_code}' https://api.botreserva.com.br/api/health || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "Health check OK!"
              curl -s https://api.botreserva.com.br/api/health | jq '.' || true

              # Limpar imagem de rollback apos sucesso
              ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "docker rmi deploy-backend-backend:rollback 2>/dev/null || true"
              exit 0
            fi
            echo "Attempt $i/30 - Status: $RESPONSE"
            sleep 5
          done

          echo "Health check failed! Initiating rollback..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            cd /root/deploy-backend
            echo "Container logs before rollback:"
            docker logs crm-backend --tail=50

            if docker images | grep -q "deploy-backend-backend:rollback"; then
              echo "Rolling back to previous version..."
              docker tag deploy-backend-backend:rollback deploy-backend-backend:latest
              docker stop crm-backend 2>/dev/null || true
              docker rm -f crm-backend 2>/dev/null || true
              docker compose -f docker-compose.production.yml up -d --no-deps backend
              sleep 10
              echo "Rollback completed. Checking health..."
              docker compose -f docker-compose.production.yml ps backend
            else
              echo "No rollback image available!"
            fi
          EOF
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f ~/.ssh/config
