name: Deploy to Production VPS

on:
  push:
    branches:
      - master
    paths:
      - 'deploy-backend/**'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_PATH: /root/deploy-backend

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: deploy-backend/package-lock.json

      - name: Install dependencies
        working-directory: deploy-backend
        run: npm ci

      - name: Run linting
        working-directory: deploy-backend
        run: npm run lint || echo "::warning::Linting issues found"

      - name: Run type check
        working-directory: deploy-backend
        run: npx tsc --noEmit || echo "::warning::Type check issues found"

      - name: Run tests
        working-directory: deploy-backend
        run: npm run test -- --coverage --passWithNoTests
        env:
          NODE_ENV: test

  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          if echo "${{ secrets.VPS_SSH_KEY }}" | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
            echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          else
            echo "${{ secrets.VPS_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key
          fi
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'SSH OK'"

      - name: Create backup
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            cd /root/deploy-backend
            mkdir -p backups
            if docker ps | grep -q crm-postgres; then
              docker exec crm-postgres pg_dump -U crm_user crm_whatsapp_saas > "backups/pre-deploy-$(date +%Y%m%d-%H%M%S).sql" 2>/dev/null || true
            fi
            ls -t backups/*.sql 2>/dev/null | tail -n +6 | xargs -r rm -f || true
          EOF

      - name: Sync files to VPS
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude 'coverage' \
            --exclude 'backups' \
            --exclude 'certbot' \
            --exclude '*.test.ts' \
            --exclude 'src/test' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            deploy-backend/ \
            ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.VPS_PATH }}/

      - name: Build and restart container
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            set -e
            cd /root/deploy-backend

            echo "Building Docker image..."
            docker compose -f docker-compose.production.yml build backend

            echo "Restarting container..."
            docker compose -f docker-compose.production.yml up -d --no-deps --force-recreate backend

            echo "Waiting for container..."
            sleep 10

            echo "Running migrations..."
            docker compose -f docker-compose.production.yml exec -T backend npx prisma migrate deploy || true

            echo "Container status:"
            docker compose -f docker-compose.production.yml ps backend
          EOF

      - name: Health check
        run: |
          for i in {1..30}; do
            RESPONSE=$(curl -s -o /dev/null -w '%{http_code}' https://api.botreserva.com.br/api/health || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "Health check OK!"
              curl -s https://api.botreserva.com.br/api/health | jq '.' || true
              exit 0
            fi
            echo "Attempt $i/30 - Status: $RESPONSE"
            sleep 5
          done
          echo "Health check failed"
          ssh -i ~/.ssh/deploy_key ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "docker logs crm-backend --tail=50"
          exit 1

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
