# Resolução do Problema de CORS - 15/11/2025

## Problema Identificado

O frontend em `https://www.botreserva.com.br` estava sendo bloqueado por CORS ao tentar fazer login em `https://api.botreserva.com.br/auth/login`.

### Erro Exato:
```
Access to XMLHttpRequest at 'https://api.botreserva.com.br/auth/login?tenant=www'
from origin 'https://www.botreserva.com.br' has been blocked by CORS policy:
Response to preflight request doesn't pass access control check:
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

## Causa Raiz

O arquivo `.env.production` na VPS foi atualizado com as novas origens permitidas, mas o Docker Compose utiliza o arquivo `.env` (sem sufixo) para carregar as variáveis de ambiente nos containers.

**Problema:**
- `.env.production` tinha: `FRONTEND_URL=https://projeto-eva-frontend.vercel.app,https://www.botreserva.com.br,https://botreserva.com.br`
- `.env` (usado pelo Docker) tinha: `FRONTEND_URL=https://app.botreserva.com.br` (valor antigo)
- O comando `docker compose restart` não recarrega variáveis de ambiente

## Solução Aplicada

### 1. Atualização do arquivo `.env` na VPS

```bash
cd /root/deploy-backend
sed -i "s|^FRONTEND_URL=.*|FRONTEND_URL=https://projeto-eva-frontend.vercel.app,https://www.botreserva.com.br,https://botreserva.com.br|" .env
```

### 2. Recriação do container (não apenas restart)

```bash
cd /root/deploy-backend
docker compose -f docker-compose.production.yml up -d --force-recreate backend
```

**Importante:** O `--force-recreate` força a recriação do container com as novas variáveis de ambiente.

## Verificação da Solução

### 1. Verificar variável no container:

```bash
docker exec crm-backend printenv FRONTEND_URL
# Output: https://projeto-eva-frontend.vercel.app,https://www.botreserva.com.br,https://botreserva.com.br
```

### 2. Testar CORS com curl:

```bash
curl -I -X OPTIONS "https://api.botreserva.com.br/auth/login?tenant=www" \
  -H "Origin: https://www.botreserva.com.br" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: content-type,authorization"
```

**Headers retornados (confirmando CORS OK):**
```
HTTP/2 204
access-control-allow-origin: https://www.botreserva.com.br
access-control-allow-credentials: true
access-control-allow-methods: GET,HEAD,PUT,PATCH,POST,DELETE
access-control-allow-headers: content-type,authorization
vary: Origin, Access-Control-Request-Headers
```

### 3. Teste com todas as origens:

| Origem | Status |
|--------|--------|
| `https://www.botreserva.com.br` | ✅ CORS OK |
| `https://botreserva.com.br` | ✅ CORS OK |
| `https://projeto-eva-frontend.vercel.app` | ✅ CORS OK |

## Lições Aprendidas

### 1. Docker Compose e Variáveis de Ambiente

- `docker compose restart` NÃO recarrega variáveis de ambiente
- Sempre usar `--force-recreate` após alterar `.env`:
  ```bash
  docker compose up -d --force-recreate [service-name]
  ```

### 2. Arquivos .env em Produção

- Docker Compose procura `.env` (sem sufixo) por padrão
- Se você tem `.env.production`, precisa:
  - Copiar para `.env`, ou
  - Especificar o arquivo: `docker compose --env-file .env.production`

### 3. Comandos Corretos para Deploy

**ERRADO:**
```bash
# Apenas restart não carrega novas env vars
docker compose restart backend
```

**CORRETO:**
```bash
# Force recreate recarrega as env vars
docker compose up -d --force-recreate backend
```

## Código Backend (server.ts)

O código do backend já estava correto, usando múltiplas origens:

```typescript
// CORS - Aceita múltiplas origens (separadas por vírgula no .env)
const allowedOrigins = env.FRONTEND_URL.split(',').map(url => url.trim());
app.use(
  cors({
    origin: allowedOrigins,
    credentials: true,
  })
);
```

## Checklist para Mudanças Futuras em CORS

- [ ] Atualizar `.env` (não `.env.production`) na VPS
- [ ] Usar `docker compose up -d --force-recreate backend`
- [ ] Verificar variável no container: `docker exec crm-backend printenv FRONTEND_URL`
- [ ] Testar CORS com curl para cada origem
- [ ] Confirmar no frontend que o login funciona

## Referências

- **VPS:** 72.61.39.235
- **Container:** crm-backend
- **Arquivo de configuração:** `/root/deploy-backend/.env`
- **Docker Compose:** `/root/deploy-backend/docker-compose.production.yml`
- **Código backend:** `deploy-backend/src/server.ts` (linhas 29-36)

## Status Final

✅ **PROBLEMA RESOLVIDO**

- CORS configurado para 3 origens diferentes
- Backend responde corretamente aos preflight requests (OPTIONS)
- Headers `Access-Control-Allow-*` presentes em todas as respostas
- Frontend pode fazer login com sucesso

---

**Data:** 15/11/2025
**Tempo de resolução:** ~15 minutos
**Impacto:** Alto (bloqueava completamente o frontend)
**Complexidade:** Baixa (configuração de ambiente)
